{"version":3,"sources":["@wordpress/block-library/src/image/transforms.js"],"names":["createBlobURL","createBlock","getBlockAttributes","dispatch","store","noticesStore","__","stripFirstImage","attributes","shortcode","body","document","implementation","createHTMLDocument","innerHTML","content","nodeToRemove","querySelector","parentNode","removeChild","trim","getFirstAnchorAttributeFormHTML","html","attributeName","firstElementChild","nodeName","getAttribute","undefined","imageSchema","img","classes","schema","phrasingContentSchema","figure","require","children","a","figcaption","transforms","from","type","isMatch","node","transform","className","alignMatches","exec","anchor","id","align","idMatches","Number","anchorElement","linkDestination","href","rel","linkClass","outerHTML","files","some","file","indexOf","createErrorNotice","every","blocks","map","url","tag","source","attribute","selector","alt","caption","named","parseInt","replace"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { createBlobURL } from '@wordpress/blob';\nimport { createBlock, getBlockAttributes } from '@wordpress/blocks';\nimport { dispatch } from '@wordpress/data';\nimport { store as noticesStore } from '@wordpress/notices';\nimport { __ } from '@wordpress/i18n';\n\nexport function stripFirstImage( attributes, { shortcode } ) {\n\tconst { body } = document.implementation.createHTMLDocument( '' );\n\n\tbody.innerHTML = shortcode.content;\n\n\tlet nodeToRemove = body.querySelector( 'img' );\n\n\t// If an image has parents, find the topmost node to remove.\n\twhile (\n\t\tnodeToRemove &&\n\t\tnodeToRemove.parentNode &&\n\t\tnodeToRemove.parentNode !== body\n\t) {\n\t\tnodeToRemove = nodeToRemove.parentNode;\n\t}\n\n\tif ( nodeToRemove ) {\n\t\tnodeToRemove.parentNode.removeChild( nodeToRemove );\n\t}\n\n\treturn body.innerHTML.trim();\n}\n\nfunction getFirstAnchorAttributeFormHTML( html, attributeName ) {\n\tconst { body } = document.implementation.createHTMLDocument( '' );\n\n\tbody.innerHTML = html;\n\n\tconst { firstElementChild } = body;\n\n\tif ( firstElementChild && firstElementChild.nodeName === 'A' ) {\n\t\treturn firstElementChild.getAttribute( attributeName ) || undefined;\n\t}\n}\n\nconst imageSchema = {\n\timg: {\n\t\tattributes: [ 'src', 'alt', 'title' ],\n\t\tclasses: [\n\t\t\t'alignleft',\n\t\t\t'aligncenter',\n\t\t\t'alignright',\n\t\t\t'alignnone',\n\t\t\t/^wp-image-\\d+$/,\n\t\t],\n\t},\n};\n\nconst schema = ( { phrasingContentSchema } ) => ( {\n\tfigure: {\n\t\trequire: [ 'img' ],\n\t\tchildren: {\n\t\t\t...imageSchema,\n\t\t\ta: {\n\t\t\t\tattributes: [ 'href', 'rel', 'target' ],\n\t\t\t\tchildren: imageSchema,\n\t\t\t},\n\t\t\tfigcaption: {\n\t\t\t\tchildren: phrasingContentSchema,\n\t\t\t},\n\t\t},\n\t},\n} );\n\nconst transforms = {\n\tfrom: [\n\t\t{\n\t\t\ttype: 'raw',\n\t\t\tisMatch: ( node ) =>\n\t\t\t\tnode.nodeName === 'FIGURE' && !! node.querySelector( 'img' ),\n\t\t\tschema,\n\t\t\ttransform: ( node ) => {\n\t\t\t\t// Search both figure and image classes. Alignment could be\n\t\t\t\t// set on either. ID is set on the image.\n\t\t\t\tconst className =\n\t\t\t\t\tnode.className +\n\t\t\t\t\t' ' +\n\t\t\t\t\tnode.querySelector( 'img' ).className;\n\t\t\t\tconst alignMatches =\n\t\t\t\t\t/(?:^|\\s)align(left|center|right)(?:$|\\s)/.exec(\n\t\t\t\t\t\tclassName\n\t\t\t\t\t);\n\t\t\t\tconst anchor = node.id === '' ? undefined : node.id;\n\t\t\t\tconst align = alignMatches ? alignMatches[ 1 ] : undefined;\n\t\t\t\tconst idMatches = /(?:^|\\s)wp-image-(\\d+)(?:$|\\s)/.exec(\n\t\t\t\t\tclassName\n\t\t\t\t);\n\t\t\t\tconst id = idMatches ? Number( idMatches[ 1 ] ) : undefined;\n\t\t\t\tconst anchorElement = node.querySelector( 'a' );\n\t\t\t\tconst linkDestination =\n\t\t\t\t\tanchorElement && anchorElement.href ? 'custom' : undefined;\n\t\t\t\tconst href =\n\t\t\t\t\tanchorElement && anchorElement.href\n\t\t\t\t\t\t? anchorElement.href\n\t\t\t\t\t\t: undefined;\n\t\t\t\tconst rel =\n\t\t\t\t\tanchorElement && anchorElement.rel\n\t\t\t\t\t\t? anchorElement.rel\n\t\t\t\t\t\t: undefined;\n\t\t\t\tconst linkClass =\n\t\t\t\t\tanchorElement && anchorElement.className\n\t\t\t\t\t\t? anchorElement.className\n\t\t\t\t\t\t: undefined;\n\t\t\t\tconst attributes = getBlockAttributes(\n\t\t\t\t\t'core/image',\n\t\t\t\t\tnode.outerHTML,\n\t\t\t\t\t{\n\t\t\t\t\t\talign,\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tlinkDestination,\n\t\t\t\t\t\thref,\n\t\t\t\t\t\trel,\n\t\t\t\t\t\tlinkClass,\n\t\t\t\t\t\tanchor,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn createBlock( 'core/image', attributes );\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\t// Note: when dragging and dropping multiple files onto a gallery this overrides the\n\t\t\t// gallery transform in order to add new images to the gallery instead of\n\t\t\t// creating a new gallery.\n\t\t\ttype: 'files',\n\t\t\tisMatch( files ) {\n\t\t\t\t// The following check is intended to catch non-image files when dropped together with images.\n\t\t\t\tif (\n\t\t\t\t\tfiles.some(\n\t\t\t\t\t\t( file ) => file.type.indexOf( 'image/' ) === 0\n\t\t\t\t\t) &&\n\t\t\t\t\tfiles.some(\n\t\t\t\t\t\t( file ) => file.type.indexOf( 'image/' ) !== 0\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconst { createErrorNotice } = dispatch( noticesStore );\n\t\t\t\t\tcreateErrorNotice(\n\t\t\t\t\t\t__(\n\t\t\t\t\t\t\t'If uploading to a gallery all files need to be image formats'\n\t\t\t\t\t\t),\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: 'gallery-transform-invalid-file',\n\t\t\t\t\t\t\ttype: 'snackbar',\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn files.every(\n\t\t\t\t\t( file ) => file.type.indexOf( 'image/' ) === 0\n\t\t\t\t);\n\t\t\t},\n\t\t\ttransform( files ) {\n\t\t\t\tconst blocks = files.map( ( file ) => {\n\t\t\t\t\treturn createBlock( 'core/image', {\n\t\t\t\t\t\turl: createBlobURL( file ),\n\t\t\t\t\t} );\n\t\t\t\t} );\n\t\t\t\treturn blocks;\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\ttype: 'shortcode',\n\t\t\ttag: 'caption',\n\t\t\tattributes: {\n\t\t\t\turl: {\n\t\t\t\t\ttype: 'string',\n\t\t\t\t\tsource: 'attribute',\n\t\t\t\t\tattribute: 'src',\n\t\t\t\t\tselector: 'img',\n\t\t\t\t},\n\t\t\t\talt: {\n\t\t\t\t\ttype: 'string',\n\t\t\t\t\tsource: 'attribute',\n\t\t\t\t\tattribute: 'alt',\n\t\t\t\t\tselector: 'img',\n\t\t\t\t},\n\t\t\t\tcaption: {\n\t\t\t\t\tshortcode: stripFirstImage,\n\t\t\t\t},\n\t\t\t\thref: {\n\t\t\t\t\tshortcode: ( attributes, { shortcode } ) => {\n\t\t\t\t\t\treturn getFirstAnchorAttributeFormHTML(\n\t\t\t\t\t\t\tshortcode.content,\n\t\t\t\t\t\t\t'href'\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\trel: {\n\t\t\t\t\tshortcode: ( attributes, { shortcode } ) => {\n\t\t\t\t\t\treturn getFirstAnchorAttributeFormHTML(\n\t\t\t\t\t\t\tshortcode.content,\n\t\t\t\t\t\t\t'rel'\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tlinkClass: {\n\t\t\t\t\tshortcode: ( attributes, { shortcode } ) => {\n\t\t\t\t\t\treturn getFirstAnchorAttributeFormHTML(\n\t\t\t\t\t\t\tshortcode.content,\n\t\t\t\t\t\t\t'class'\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tid: {\n\t\t\t\t\ttype: 'number',\n\t\t\t\t\tshortcode: ( { named: { id } } ) => {\n\t\t\t\t\t\tif ( ! id ) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn parseInt( id.replace( 'attachment_', '' ), 10 );\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\talign: {\n\t\t\t\t\ttype: 'string',\n\t\t\t\t\tshortcode: ( { named: { align = 'alignnone' } } ) => {\n\t\t\t\t\t\treturn align.replace( 'align', '' );\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t],\n};\n\nexport default transforms;\n"]}