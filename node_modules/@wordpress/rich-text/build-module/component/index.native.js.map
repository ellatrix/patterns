{"version":3,"sources":["@wordpress/rich-text/src/component/index.native.js"],"names":["View","Platform","Dimensions","memize","colord","RCTAztecView","showUserSuggestions","showXpostSuggestions","BlockFormatControls","getPxFromCssUnit","Component","compose","debounce","withPreferredColorScheme","withSelect","childrenBlock","decodeEntities","BACKSPACE","DELETE","ENTER","isURL","atSymbol","plus","__","useFormatTypes","FormatEdit","applyFormat","getActiveFormat","getActiveFormats","insert","getTextContent","isEmpty","isEmptyLine","create","toHTMLString","removeLineSeparator","isCollapsed","remove","getFormatColors","styles","ToolbarButtonWithOptions","unescapeSpaces","text","replace","flatColorPalettes","colorsPalettes","theme","custom","default","gutenbergFormatNamesToAztec","EMPTY_PARAGRAPH_TAGS","DEFAULT_FONT_SIZE","MIN_LINE_HEIGHT","RichText","constructor","value","selectionStart","selectionEnd","__unstableMultilineTag","multiline","arguments","isMultiline","multilineTag","multilineWrapperTags","isIOS","OS","createRecord","bind","restoreParagraphTags","onChangeFromAztec","onKeyDown","handleEnter","handleDelete","onPaste","onFocus","onBlur","onTextUpdate","onContentSizeChange","onFormatChange","formatToValue","maxSize","debounceCreateUndoLevel","onCreateUndoLevel","onSelectionChange","onSelectionChangeFromAztec","valueToFormat","getHtmlToRender","handleSuggestionFunc","handleUserSuggestion","handleXpostSuggestion","suggestionOptions","insertString","manipulateEventCounterToForceNativeToRefresh","shouldDropEventFromAztec","state","activeFormats","selectedFormat","height","currentFontSize","getFontSize","needsSelectionUpdate","savedContent","isTouched","lastAztecEventType","lastHistoryValue","getRecord","start","end","colorPalette","props","currentValue","formats","replacements","newFormats","preserveWhiteSpace","html","range","Math","min","length","removeRootTagsProduceByAztec","getActiveFormatNames","record","formatTypes","map","name","filter","undefined","Boolean","changeHandlers","Object","fromEntries","entries","key","startsWith","values","forEach","changeHandler","onChange","setState","string","toInsert","__unstableOnCreateUndoLevel","result","removeRootTag","tagName","rootTagsToEliminate","element","tagsToEliminate","removeTag","tag","openingTagRegexp","RegExp","closingTagRegexp","event","contentWithoutRootTag","nativeEvent","lastEventCount","eventCount","comesFromAztec","firedAfterTextChanged","formattedContent","refresh","contentSize","defaultPrevented","customEditableOnKeyDown","preventDefault","KeyCodes","keyCode","handleTriggerKeyCodes","onEnter","shiftKey","isReverse","onDelete","newValue","triggeredOption","find","option","triggeredKeyCode","triggerChar","charCodeAt","useTrigger","charAt","onClick","areMentionsSupported","areXPostsSupported","allOptions","supported","title","label","icon","op","suggestionFunction","prefix","then","suggestion","catch","pastedText","pastedHtml","files","currentRecord","trimmedText","trim","linkedRecord","type","attributes","href","window","console","log","plainText","unstableOnFocus","hasChanged","isManual","logText","shouldDrop","realStart","realEnd","max","__unstableIsSelected","Array","isArray","toHTML","format","shouldComponentUpdate","nextProps","nextState","reversed","fontSize","style","lineHeight","componentDidMount","blockIsSelected","__unstableMobileNoFocusOnMount","_editor","focus","componentWillUnmount","isFocused","blur","componentDidUpdate","prevProps","isSelected","prevIsSelected","currentFontSizeStyle","getParsedFontSize","prevFontSizeStyle","isDifferentTag","extraAttributes","getEditableProps","className","width","get","cssUnitOptions","selectedPxValue","parseFloat","baseGlobalStyles","tagNameFontSize","elements","typography","newFontSize","getLineHeight","tagNameLineHeight","newLineHeight","getIsBlockBasedTheme","isNaN","getBlockUseDefaultFont","isBlockBasedTheme","tagsToMatch","test","getLinkTextColor","defaultColor","customColor","linkColor","isValid","toHex","render","children","getStylesFromColorScheme","minWidth","maxWidth","parentBlockStyles","accessibilityLabel","disableEditingMenu","disableSuggestions","containerWidth","editableProps","blockUseDefaultFont","placeholderStyle","richTextPlaceholder","richTextPlaceholderDark","color","defaultPlaceholderTextColor","textDecorationColor","defaultTextDecorationColor","fontFamily","defaultFontFamily","richText","richTextDark","linkTextColor","currentSelectionStart","currentSelectionEnd","selection","brBeforeParaMatches","match","warn","count","newSelectionStart","newSelectionEnd","containerStyles","padding","backgroundColor","EditableView","editableTagName","ref","setRef","minHeight","placeholder","placeholderColor","placeholderTextColor","deleteEnter","onCaretVerticalPositionChange","fontWeight","fontStyle","textAlign","id","selectionColor","disableAutocorrection","defaultProps","withFormatTypes","WrappedComponent","clientId","identifier","withoutInteractiveFormatting","allowedFormats","select","getBlockParents","getBlock","getSettings","parents","parentBlock","childrenStyles","settings","__experimentalGlobalStylesBaseStyles","colorPalettes","__experimentalFeatures","palette","colors","capabilities","mentions","xposts"],"mappings":"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","sourcesContent":["/* eslint no-console: [\"error\", { allow: [\"warn\"] }] */\n\n/**\n * External dependencies\n */\nimport { View, Platform, Dimensions } from 'react-native';\nimport memize from 'memize';\nimport { colord } from 'colord';\n\n/**\n * WordPress dependencies\n */\nimport RCTAztecView from '@wordpress/react-native-aztec';\nimport {\n\tshowUserSuggestions,\n\tshowXpostSuggestions,\n} from '@wordpress/react-native-bridge';\nimport { BlockFormatControls, getPxFromCssUnit } from '@wordpress/block-editor';\nimport { Component } from '@wordpress/element';\nimport {\n\tcompose,\n\tdebounce,\n\twithPreferredColorScheme,\n} from '@wordpress/compose';\nimport { withSelect } from '@wordpress/data';\nimport { childrenBlock } from '@wordpress/blocks';\nimport { decodeEntities } from '@wordpress/html-entities';\nimport { BACKSPACE, DELETE, ENTER } from '@wordpress/keycodes';\nimport { isURL } from '@wordpress/url';\nimport { atSymbol, plus } from '@wordpress/icons';\nimport { __ } from '@wordpress/i18n';\n\n/**\n * Internal dependencies\n */\nimport { useFormatTypes } from './use-format-types';\nimport FormatEdit from './format-edit';\nimport { applyFormat } from '../apply-format';\nimport { getActiveFormat } from '../get-active-format';\nimport { getActiveFormats } from '../get-active-formats';\nimport { insert } from '../insert';\nimport { getTextContent } from '../get-text-content';\nimport { isEmpty, isEmptyLine } from '../is-empty';\nimport { create } from '../create';\nimport { toHTMLString } from '../to-html-string';\nimport { removeLineSeparator } from '../remove-line-separator';\nimport { isCollapsed } from '../is-collapsed';\nimport { remove } from '../remove';\nimport { getFormatColors } from '../get-format-colors';\nimport styles from './style.scss';\nimport ToolbarButtonWithOptions from './toolbar-button-with-options';\n\nconst unescapeSpaces = ( text ) => {\n\treturn text.replace( /&nbsp;|&#160;/gi, ' ' );\n};\n\n// The flattened color palettes array is memoized to ensure that the same array instance is\n// returned for the colors palettes. This value might be used as a prop, so having the same\n// instance will prevent unnecessary re-renders of the RichText component.\nconst flatColorPalettes = memize( ( colorsPalettes ) => [\n\t...( colorsPalettes?.theme || [] ),\n\t...( colorsPalettes?.custom || [] ),\n\t...( colorsPalettes?.default || [] ),\n] );\n\nconst gutenbergFormatNamesToAztec = {\n\t'core/bold': 'bold',\n\t'core/italic': 'italic',\n\t'core/strikethrough': 'strikethrough',\n\t'core/text-color': 'mark',\n};\n\nconst EMPTY_PARAGRAPH_TAGS = '<p></p>';\nconst DEFAULT_FONT_SIZE = 16;\nconst MIN_LINE_HEIGHT = 1;\n\nexport class RichText extends Component {\n\tconstructor( {\n\t\tvalue,\n\t\tselectionStart,\n\t\tselectionEnd,\n\t\t__unstableMultilineTag: multiline,\n\t} ) {\n\t\tsuper( ...arguments );\n\n\t\tthis.isMultiline = false;\n\t\tif ( multiline === true || multiline === 'p' || multiline === 'li' ) {\n\t\t\tthis.multilineTag = multiline === true ? 'p' : multiline;\n\t\t\tthis.isMultiline = true;\n\t\t}\n\n\t\tif ( this.multilineTag === 'li' ) {\n\t\t\tthis.multilineWrapperTags = [ 'ul', 'ol' ];\n\t\t}\n\n\t\tthis.isIOS = Platform.OS === 'ios';\n\t\tthis.createRecord = this.createRecord.bind( this );\n\t\tthis.restoreParagraphTags = this.restoreParagraphTags.bind( this );\n\t\tthis.onChangeFromAztec = this.onChangeFromAztec.bind( this );\n\t\tthis.onKeyDown = this.onKeyDown.bind( this );\n\t\tthis.handleEnter = this.handleEnter.bind( this );\n\t\tthis.handleDelete = this.handleDelete.bind( this );\n\t\tthis.onPaste = this.onPaste.bind( this );\n\t\tthis.onFocus = this.onFocus.bind( this );\n\t\tthis.onBlur = this.onBlur.bind( this );\n\t\tthis.onTextUpdate = this.onTextUpdate.bind( this );\n\t\tthis.onContentSizeChange = this.onContentSizeChange.bind( this );\n\t\tthis.onFormatChange = this.onFormatChange.bind( this );\n\t\tthis.formatToValue = memize( this.formatToValue.bind( this ), {\n\t\t\tmaxSize: 1,\n\t\t} );\n\t\tthis.debounceCreateUndoLevel = debounce( this.onCreateUndoLevel, 1000 );\n\t\t// This prevents a bug in Aztec which triggers onSelectionChange twice on format change.\n\t\tthis.onSelectionChange = this.onSelectionChange.bind( this );\n\t\tthis.onSelectionChangeFromAztec =\n\t\t\tthis.onSelectionChangeFromAztec.bind( this );\n\t\tthis.valueToFormat = this.valueToFormat.bind( this );\n\t\tthis.getHtmlToRender = this.getHtmlToRender.bind( this );\n\t\tthis.handleSuggestionFunc = this.handleSuggestionFunc.bind( this );\n\t\tthis.handleUserSuggestion = this.handleSuggestionFunc(\n\t\t\tshowUserSuggestions,\n\t\t\t'@'\n\t\t).bind( this );\n\t\tthis.handleXpostSuggestion = this.handleSuggestionFunc(\n\t\t\tshowXpostSuggestions,\n\t\t\t'+'\n\t\t).bind( this );\n\t\tthis.suggestionOptions = this.suggestionOptions.bind( this );\n\t\tthis.insertString = this.insertString.bind( this );\n\t\tthis.manipulateEventCounterToForceNativeToRefresh =\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh.bind( this );\n\t\tthis.shouldDropEventFromAztec =\n\t\t\tthis.shouldDropEventFromAztec.bind( this );\n\t\tthis.state = {\n\t\t\tactiveFormats: [],\n\t\t\tselectedFormat: null,\n\t\t\theight: 0,\n\t\t\tcurrentFontSize: this.getFontSize( arguments[ 0 ] ),\n\t\t};\n\t\tthis.needsSelectionUpdate = false;\n\t\tthis.savedContent = '';\n\t\tthis.isTouched = false;\n\t\tthis.lastAztecEventType = null;\n\n\t\tthis.lastHistoryValue = value;\n\n\t\t// Internal values that are update synchronously, unlike props.\n\t\tthis.value = value;\n\t\tthis.selectionStart = selectionStart;\n\t\tthis.selectionEnd = selectionEnd;\n\t}\n\n\t/**\n\t * Get the current record (value and selection) from props and state.\n\t *\n\t * @return {Object} The current record (value and selection).\n\t */\n\tgetRecord() {\n\t\tconst {\n\t\t\tselectionStart: start,\n\t\t\tselectionEnd: end,\n\t\t\tcolorPalette,\n\t\t} = this.props;\n\t\tconst { value } = this.props;\n\t\tconst currentValue = this.formatToValue( value );\n\n\t\tconst { formats, replacements, text } = currentValue;\n\t\tconst { activeFormats } = this.state;\n\t\tconst newFormats = getFormatColors( value, formats, colorPalette );\n\n\t\treturn {\n\t\t\tformats: newFormats,\n\t\t\treplacements,\n\t\t\ttext,\n\t\t\tstart,\n\t\t\tend,\n\t\t\tactiveFormats,\n\t\t};\n\t}\n\n\t/**\n\t * Creates a RichText value \"record\" from the current content and selection\n\t * information\n\t *\n\t *\n\t * @return {Object} A RichText value with formats and selection.\n\t */\n\tcreateRecord() {\n\t\tconst { preserveWhiteSpace } = this.props;\n\t\tconst value = {\n\t\t\tstart: this.selectionStart,\n\t\t\tend: this.selectionEnd,\n\t\t\t...create( {\n\t\t\t\thtml: this.value,\n\t\t\t\trange: null,\n\t\t\t\tmultilineTag: this.multilineTag,\n\t\t\t\tmultilineWrapperTags: this.multilineWrapperTags,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} ),\n\t\t};\n\t\tconst start = Math.min( this.selectionStart, value.text.length );\n\t\tconst end = Math.min( this.selectionEnd, value.text.length );\n\t\treturn { ...value, start, end };\n\t}\n\n\tvalueToFormat( value ) {\n\t\t// Remove the outer root tags.\n\t\treturn this.removeRootTagsProduceByAztec(\n\t\t\ttoHTMLString( {\n\t\t\t\tvalue,\n\t\t\t\tmultilineTag: this.multilineTag,\n\t\t\t} )\n\t\t);\n\t}\n\n\tgetActiveFormatNames( record ) {\n\t\tconst { formatTypes } = this.props;\n\n\t\treturn formatTypes\n\t\t\t.map( ( { name } ) => name )\n\t\t\t.filter( ( name ) => {\n\t\t\t\treturn getActiveFormat( record, name ) !== undefined;\n\t\t\t} )\n\t\t\t.map( ( name ) => gutenbergFormatNamesToAztec[ name ] )\n\t\t\t.filter( Boolean );\n\t}\n\n\tonFormatChange( record ) {\n\t\tconst { start = 0, end = 0, activeFormats = [] } = record;\n\t\tconst changeHandlers = Object.fromEntries(\n\t\t\tObject.entries( this.props ).filter( ( [ key ] ) =>\n\t\t\t\tkey.startsWith( 'format_on_change_functions_' )\n\t\t\t)\n\t\t);\n\n\t\tObject.values( changeHandlers ).forEach( ( changeHandler ) => {\n\t\t\tchangeHandler( record.formats, record.text );\n\t\t} );\n\n\t\tthis.value = this.valueToFormat( record );\n\t\tthis.props.onChange( this.value );\n\t\tthis.setState( { activeFormats } );\n\t\tthis.props.onSelectionChange( start, end );\n\t\tthis.selectionStart = start;\n\t\tthis.selectionEnd = end;\n\n\t\tthis.onCreateUndoLevel();\n\n\t\tthis.lastAztecEventType = 'format change';\n\t}\n\n\tinsertString( record, string ) {\n\t\tif ( record && string ) {\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\tconst toInsert = insert( record, string );\n\t\t\tthis.onFormatChange( toInsert );\n\t\t}\n\t}\n\n\tonCreateUndoLevel() {\n\t\tconst { __unstableOnCreateUndoLevel: onCreateUndoLevel } = this.props;\n\t\t// If the content is the same, no level needs to be created.\n\t\tif ( this.lastHistoryValue === this.value ) {\n\t\t\treturn;\n\t\t}\n\n\t\tonCreateUndoLevel();\n\t\tthis.lastHistoryValue = this.value;\n\t}\n\n\t/*\n\t * Cleans up any root tags produced by aztec.\n\t * TODO: This should be removed on a later version when aztec doesn't return the top tag of the text being edited\n\t */\n\tremoveRootTagsProduceByAztec( html ) {\n\t\tlet result = this.removeRootTag( this.props.tagName, html );\n\t\t// Temporary workaround for https://github.com/WordPress/gutenberg/pull/13763\n\t\tif ( this.props.rootTagsToEliminate ) {\n\t\t\tthis.props.rootTagsToEliminate.forEach( ( element ) => {\n\t\t\t\tresult = this.removeRootTag( element, result );\n\t\t\t} );\n\t\t}\n\n\t\tif ( this.props.tagsToEliminate ) {\n\t\t\tthis.props.tagsToEliminate.forEach( ( element ) => {\n\t\t\t\tresult = this.removeTag( element, result );\n\t\t\t} );\n\t\t}\n\t\treturn result;\n\t}\n\n\tremoveRootTag( tag, html ) {\n\t\tconst openingTagRegexp = RegExp( '^<' + tag + '[^>]*>', 'gim' );\n\t\tconst closingTagRegexp = RegExp( '</' + tag + '>$', 'gim' );\n\t\treturn html\n\t\t\t.replace( openingTagRegexp, '' )\n\t\t\t.replace( closingTagRegexp, '' );\n\t}\n\tremoveTag( tag, html ) {\n\t\tconst openingTagRegexp = RegExp( '<' + tag + '>', 'gim' );\n\t\tconst closingTagRegexp = RegExp( '</' + tag + '>', 'gim' );\n\t\treturn html\n\t\t\t.replace( openingTagRegexp, '' )\n\t\t\t.replace( closingTagRegexp, '' );\n\t}\n\n\t/*\n\t * Handles any case where the content of the AztecRN instance has changed\n\t */\n\tonChangeFromAztec( event ) {\n\t\tif ( this.shouldDropEventFromAztec( event, 'onChange' ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst contentWithoutRootTag = this.removeRootTagsProduceByAztec(\n\t\t\tunescapeSpaces( event.nativeEvent.text )\n\t\t);\n\t\t// On iOS, onChange can be triggered after selection changes, even though there are no content changes.\n\t\tif ( contentWithoutRootTag === this.value ) {\n\t\t\treturn;\n\t\t}\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\n\t\tthis.comesFromAztec = true;\n\t\tthis.firedAfterTextChanged = true; // The onChange event always fires after the fact.\n\t\tthis.onTextUpdate( event );\n\t\tthis.lastAztecEventType = 'input';\n\t}\n\n\tonTextUpdate( event ) {\n\t\tconst contentWithoutRootTag = this.removeRootTagsProduceByAztec(\n\t\t\tunescapeSpaces( event.nativeEvent.text )\n\t\t);\n\t\tlet formattedContent = contentWithoutRootTag;\n\t\tif ( ! this.isIOS ) {\n\t\t\tformattedContent = this.restoreParagraphTags(\n\t\t\t\tcontentWithoutRootTag,\n\t\t\t\tthis.multilineTag\n\t\t\t);\n\t\t}\n\n\t\tthis.debounceCreateUndoLevel();\n\t\tconst refresh = this.value !== formattedContent;\n\t\tthis.value = formattedContent;\n\n\t\t// We don't want to refresh if our goal is just to create a record.\n\t\tif ( refresh ) {\n\t\t\tthis.props.onChange( formattedContent );\n\t\t}\n\t}\n\n\trestoreParagraphTags( value, tag ) {\n\t\tif ( tag === 'p' && ( ! value || ! value.startsWith( '<p>' ) ) ) {\n\t\t\treturn '<p>' + value + '</p>';\n\t\t}\n\t\treturn value;\n\t}\n\n\t/*\n\t * Handles any case where the content of the AztecRN instance has changed in size\n\t */\n\tonContentSizeChange( contentSize ) {\n\t\tthis.setState( contentSize );\n\t\tthis.lastAztecEventType = 'content size change';\n\t}\n\n\tonKeyDown( event ) {\n\t\tif ( event.defaultPrevented ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Add stubs for conformance in downstream autocompleters logic.\n\t\tthis.customEditableOnKeyDown?.( {\n\t\t\tpreventDefault: () => undefined,\n\t\t\t...event,\n\t\t\tkey: RCTAztecView.KeyCodes[ event?.keyCode ],\n\t\t} );\n\n\t\tthis.handleDelete( event );\n\t\tthis.handleEnter( event );\n\t\tthis.handleTriggerKeyCodes( event );\n\t}\n\n\thandleEnter( event ) {\n\t\tif ( event.keyCode !== ENTER ) {\n\t\t\treturn;\n\t\t}\n\t\tconst { onEnter } = this.props;\n\n\t\tif ( ! onEnter ) {\n\t\t\treturn;\n\t\t}\n\n\t\tonEnter( {\n\t\t\tvalue: this.createRecord(),\n\t\t\tonChange: this.onFormatChange,\n\t\t\tshiftKey: event.shiftKey,\n\t\t} );\n\t\tthis.lastAztecEventType = 'input';\n\t}\n\n\thandleDelete( event ) {\n\t\tif ( this.shouldDropEventFromAztec( event, 'handleDelete' ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { keyCode } = event;\n\n\t\tif ( keyCode !== DELETE && keyCode !== BACKSPACE ) {\n\t\t\treturn;\n\t\t}\n\t\tconst isReverse = keyCode === BACKSPACE;\n\n\t\tconst { onDelete, __unstableMultilineTag: multilineTag } = this.props;\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\n\t\tthis.comesFromAztec = true;\n\t\tthis.firedAfterTextChanged = event.nativeEvent.firedAfterTextChanged;\n\t\tconst value = this.createRecord();\n\t\tconst { start, end, text } = value;\n\t\tlet newValue;\n\n\t\t// Always handle full content deletion ourselves.\n\t\tif ( start === 0 && end !== 0 && end >= text.length ) {\n\t\t\tnewValue = remove( value );\n\t\t\tthis.onFormatChange( newValue );\n\t\t\tevent.preventDefault();\n\t\t\treturn;\n\t\t}\n\n\t\tif ( multilineTag ) {\n\t\t\tif (\n\t\t\t\tisReverse &&\n\t\t\t\tvalue.start === 0 &&\n\t\t\t\tvalue.end === 0 &&\n\t\t\t\tisEmptyLine( value )\n\t\t\t) {\n\t\t\t\tnewValue = removeLineSeparator( value, ! isReverse );\n\t\t\t} else {\n\t\t\t\tnewValue = removeLineSeparator( value, isReverse );\n\t\t\t}\n\t\t\tif ( newValue ) {\n\t\t\t\tthis.onFormatChange( newValue );\n\t\t\t\tevent.preventDefault();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Only process delete if the key press occurs at an uncollapsed edge.\n\t\tif (\n\t\t\t! onDelete ||\n\t\t\t! isCollapsed( value ) ||\n\t\t\t( isReverse && start !== 0 ) ||\n\t\t\t( ! isReverse && end !== text.length )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tonDelete( { isReverse, value } );\n\n\t\tevent.preventDefault();\n\t\tthis.lastAztecEventType = 'input';\n\t}\n\n\thandleTriggerKeyCodes( event ) {\n\t\tconst { keyCode } = event;\n\t\tconst triggeredOption = this.suggestionOptions().find( ( option ) => {\n\t\t\tconst triggeredKeyCode = option.triggerChar.charCodeAt( 0 );\n\t\t\treturn triggeredKeyCode === keyCode;\n\t\t} );\n\n\t\tif ( triggeredOption ) {\n\t\t\tconst record = this.getRecord();\n\t\t\tconst text = getTextContent( record );\n\t\t\t// Only respond to the trigger if the selection is on the start of text or line\n\t\t\t// or if the character before is a space.\n\t\t\tconst useTrigger =\n\t\t\t\ttext.length === 0 ||\n\t\t\t\trecord.start === 0 ||\n\t\t\t\ttext.charAt( record.start - 1 ) === '\\n' ||\n\t\t\t\ttext.charAt( record.start - 1 ) === ' ';\n\n\t\t\tif ( useTrigger && triggeredOption.onClick ) {\n\t\t\t\ttriggeredOption.onClick();\n\t\t\t} else {\n\t\t\t\tthis.insertString( record, triggeredOption.triggerChar );\n\t\t\t}\n\t\t}\n\t}\n\n\tsuggestionOptions() {\n\t\tconst { areMentionsSupported, areXPostsSupported } = this.props;\n\t\tconst allOptions = [\n\t\t\t{\n\t\t\t\tsupported: areMentionsSupported,\n\t\t\t\ttitle: __( 'Insert mention' ),\n\t\t\t\tonClick: this.handleUserSuggestion,\n\t\t\t\ttriggerChar: '@',\n\t\t\t\tvalue: 'mention',\n\t\t\t\tlabel: __( 'Mention' ),\n\t\t\t\ticon: atSymbol,\n\t\t\t},\n\t\t\t{\n\t\t\t\tsupported: areXPostsSupported,\n\t\t\t\ttitle: __( 'Insert crosspost' ),\n\t\t\t\tonClick: this.handleXpostSuggestion,\n\t\t\t\ttriggerChar: '+',\n\t\t\t\tvalue: 'crosspost',\n\t\t\t\tlabel: __( 'Crosspost' ),\n\t\t\t\ticon: plus,\n\t\t\t},\n\t\t];\n\t\treturn allOptions.filter( ( op ) => op.supported );\n\t}\n\n\thandleSuggestionFunc( suggestionFunction, prefix ) {\n\t\treturn () => {\n\t\t\tconst record = this.getRecord();\n\t\t\tsuggestionFunction()\n\t\t\t\t.then( ( suggestion ) => {\n\t\t\t\t\tthis.insertString( record, `${ prefix }${ suggestion } ` );\n\t\t\t\t} )\n\t\t\t\t.catch( () => {} );\n\t\t};\n\t}\n\n\t/**\n\t * Handles a paste event from the native Aztec Wrapper.\n\t *\n\t * @param {Object} event The paste event which wraps `nativeEvent`.\n\t */\n\tonPaste( event ) {\n\t\tconst { onPaste, onChange } = this.props;\n\t\tconst { activeFormats = [] } = this.state;\n\n\t\tconst { pastedText, pastedHtml, files } = event.nativeEvent;\n\t\tconst currentRecord = this.createRecord();\n\n\t\tevent.preventDefault();\n\n\t\t// There is a selection, check if a URL is pasted.\n\t\tif ( ! isCollapsed( currentRecord ) ) {\n\t\t\tconst trimmedText = ( pastedHtml || pastedText )\n\t\t\t\t.replace( /<[^>]+>/g, '' )\n\t\t\t\t.trim();\n\n\t\t\t// A URL was pasted, turn the selection into a link.\n\t\t\tif ( isURL( trimmedText ) ) {\n\t\t\t\tconst linkedRecord = applyFormat( currentRecord, {\n\t\t\t\t\ttype: 'a',\n\t\t\t\t\tattributes: {\n\t\t\t\t\t\thref: decodeEntities( trimmedText ),\n\t\t\t\t\t},\n\t\t\t\t} );\n\t\t\t\tthis.value = this.valueToFormat( linkedRecord );\n\t\t\t\tonChange( this.value );\n\n\t\t\t\t// Allows us to ask for this information when we get a report.\n\t\t\t\twindow.console.log( 'Created link:\\n\\n', trimmedText );\n\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif ( onPaste ) {\n\t\t\tonPaste( {\n\t\t\t\tvalue: currentRecord,\n\t\t\t\tonChange: this.onFormatChange,\n\t\t\t\thtml: pastedHtml,\n\t\t\t\tplainText: pastedText,\n\t\t\t\tfiles,\n\t\t\t\tactiveFormats,\n\t\t\t} );\n\t\t}\n\t}\n\n\tonFocus() {\n\t\tthis.isTouched = true;\n\n\t\tconst { unstableOnFocus, onSelectionChange } = this.props;\n\n\t\tif ( unstableOnFocus ) {\n\t\t\tunstableOnFocus();\n\t\t}\n\n\t\t// We know for certain that on focus, the old selection is invalid. It\n\t\t// will be recalculated on `selectionchange`.\n\n\t\tonSelectionChange( this.selectionStart, this.selectionEnd );\n\n\t\tthis.lastAztecEventType = 'focus';\n\t}\n\n\tonBlur( event ) {\n\t\tthis.isTouched = false;\n\n\t\t// Check if value is up to date with latest state of native AztecView.\n\t\tif (\n\t\t\tevent.nativeEvent.text &&\n\t\t\tevent.nativeEvent.text !== this.props.value\n\t\t) {\n\t\t\tthis.onTextUpdate( event );\n\t\t}\n\n\t\tif ( this.props.onBlur ) {\n\t\t\tthis.props.onBlur( event );\n\t\t}\n\n\t\tthis.lastAztecEventType = 'blur';\n\t}\n\n\tonSelectionChange( start, end ) {\n\t\tconst hasChanged =\n\t\t\tthis.selectionStart !== start || this.selectionEnd !== end;\n\n\t\tthis.selectionStart = start;\n\t\tthis.selectionEnd = end;\n\n\t\t// This is a manual selection change event if onChange was not triggered just before\n\t\t// and we did not just trigger a text update\n\t\t// `onChange` could be the last event and could have been triggered a long time ago so\n\t\t// this approach is not perfectly reliable.\n\t\tconst isManual =\n\t\t\tthis.lastAztecEventType !== 'input' &&\n\t\t\tthis.props.value === this.value;\n\t\tif ( hasChanged && isManual ) {\n\t\t\tconst value = this.createRecord();\n\t\t\tconst activeFormats = getActiveFormats( value );\n\t\t\tthis.setState( { activeFormats } );\n\t\t}\n\n\t\tthis.props.onSelectionChange( start, end );\n\t}\n\n\tshouldDropEventFromAztec( event, logText ) {\n\t\tconst shouldDrop =\n\t\t\t! this.isIOS && event.nativeEvent.eventCount <= this.lastEventCount;\n\t\tif ( shouldDrop ) {\n\t\t\twindow.console.log(\n\t\t\t\t`Dropping ${ logText } from Aztec as its event counter is older than latest sent to the native side. Got ${ event.nativeEvent.eventCount } but lastEventCount is ${ this.lastEventCount }.`\n\t\t\t);\n\t\t}\n\t\treturn shouldDrop;\n\t}\n\n\tonSelectionChangeFromAztec( start, end, text, event ) {\n\t\tif ( this.shouldDropEventFromAztec( event, 'onSelectionChange' ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// `end` can be less than `start` on iOS\n\t\t// Let's fix that here so `rich-text/slice` can work properly.\n\t\tconst realStart = Math.min( start, end );\n\t\tconst realEnd = Math.max( start, end );\n\n\t\t// Check and dicsard stray event, where the text and selection is equal to the ones already cached.\n\t\tconst contentWithoutRootTag = this.removeRootTagsProduceByAztec(\n\t\t\tunescapeSpaces( event.nativeEvent.text )\n\t\t);\n\t\tif (\n\t\t\tcontentWithoutRootTag === this.value &&\n\t\t\trealStart === this.selectionStart &&\n\t\t\trealEnd === this.selectionEnd\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.comesFromAztec = true;\n\t\tthis.firedAfterTextChanged = true; // Selection change event always fires after the fact.\n\n\t\t// Update text before updating selection\n\t\t// Make sure there are changes made to the content before upgrading it upward.\n\t\tthis.onTextUpdate( event );\n\n\t\t// Aztec can send us selection change events after it has lost focus.\n\t\t// For instance the autocorrect feature will complete a partially written\n\t\t// word when resigning focus, causing a selection change event.\n\t\t// Forwarding this selection change could cause this RichText to regain\n\t\t// focus and start a focus loop.\n\t\t//\n\t\t// See https://github.com/wordpress-mobile/gutenberg-mobile/issues/1696\n\t\tif ( this.props.__unstableIsSelected ) {\n\t\t\tthis.onSelectionChange( realStart, realEnd );\n\t\t}\n\t\t// Update lastEventCount to prevent Aztec from re-rendering the content it just sent.\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\n\n\t\tthis.lastAztecEventType = 'selection change';\n\t}\n\n\tisEmpty() {\n\t\treturn isEmpty( this.formatToValue( this.props.value ) );\n\t}\n\n\tformatToValue( value ) {\n\t\tconst { preserveWhiteSpace } = this.props;\n\t\t// Handle deprecated `children` and `node` sources.\n\t\tif ( Array.isArray( value ) ) {\n\t\t\treturn create( {\n\t\t\t\thtml: childrenBlock.toHTML( value ),\n\t\t\t\tmultilineTag: this.multilineTag,\n\t\t\t\tmultilineWrapperTags: this.multilineWrapperTags,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\t\t}\n\n\t\tif ( this.props.format === 'string' ) {\n\t\t\treturn create( {\n\t\t\t\thtml: value,\n\t\t\t\tmultilineTag: this.multilineTag,\n\t\t\t\tmultilineWrapperTags: this.multilineWrapperTags,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\t\t}\n\n\t\t// Guard for blocks passing `null` in onSplit callbacks. May be removed\n\t\t// if onSplit is revised to not pass a `null` value.\n\t\tif ( value === null ) {\n\t\t\treturn create();\n\t\t}\n\n\t\treturn value;\n\t}\n\n\tmanipulateEventCounterToForceNativeToRefresh() {\n\t\tif ( this.isIOS ) {\n\t\t\tthis.lastEventCount = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tif ( typeof this.lastEventCount !== 'undefined' ) {\n\t\t\tthis.lastEventCount += 100; // bump by a hundred, hopefully native hasn't bombarded the JS side in the meantime.\n\t\t} // no need to bump when 'undefined' as native side won't receive the key when the value is undefined, and that will cause force updating anyway,\n\t\t//   see https://github.com/WordPress/gutenberg/blob/82e578dcc75e67891c750a41a04c1e31994192fc/packages/react-native-aztec/android/src/main/java/org/wordpress/mobile/ReactNativeAztec/ReactAztecManager.java#L213-L215\n\t}\n\n\tshouldComponentUpdate( nextProps, nextState ) {\n\t\tif (\n\t\t\tnextProps.tagName !== this.props.tagName ||\n\t\t\tnextProps.reversed !== this.props.reversed ||\n\t\t\tnextProps.start !== this.props.start\n\t\t) {\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\tthis.value = undefined;\n\t\t\treturn true;\n\t\t}\n\n\t\t// TODO: Please re-introduce the check to avoid updating the content right after an `onChange` call.\n\t\t// It was removed in https://github.com/WordPress/gutenberg/pull/12417 to fix undo/redo problem.\n\n\t\t// If the component is changed React side (undo/redo/merging/splitting/custom text actions)\n\t\t// we need to make sure the native is updated as well.\n\n\t\t// Also, don't trust the \"this.lastContent\" as on Android, incomplete text events arrive\n\t\t//  with only some of the text, while the virtual keyboard's suggestion system does its magic.\n\t\t// ** compare with this.lastContent for optimizing performance by not forcing Aztec with text it already has\n\t\t// , but compare with props.value to not lose \"half word\" text because of Android virtual keyb autosuggestion behavior\n\t\tif (\n\t\t\ttypeof nextProps.value !== 'undefined' &&\n\t\t\ttypeof this.props.value !== 'undefined' &&\n\t\t\t( ! this.comesFromAztec || ! this.firedAfterTextChanged ) &&\n\t\t\tnextProps.value !== this.props.value\n\t\t) {\n\t\t\t// Gutenberg seems to try to mirror the caret state even on events that only change the content so,\n\t\t\t//  let's force caret update if state has selection set.\n\t\t\tif (\n\t\t\t\ttypeof nextProps.selectionStart !== 'undefined' &&\n\t\t\t\ttypeof nextProps.selectionEnd !== 'undefined'\n\t\t\t) {\n\t\t\t\tthis.needsSelectionUpdate = true;\n\t\t\t}\n\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t}\n\n\t\tif ( ! this.comesFromAztec ) {\n\t\t\tif (\n\t\t\t\ttypeof nextProps.selectionStart !== 'undefined' &&\n\t\t\t\ttypeof nextProps.selectionEnd !== 'undefined' &&\n\t\t\t\tnextProps.selectionStart !== this.props.selectionStart &&\n\t\t\t\tnextProps.selectionStart !== this.selectionStart &&\n\t\t\t\tnextProps.__unstableIsSelected\n\t\t\t) {\n\t\t\t\tthis.needsSelectionUpdate = true;\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\t}\n\n\t\t\t// For font size changes from a prop value a force refresh\n\t\t\t// is needed without the selection update.\n\t\t\tif ( nextProps?.fontSize !== this.props?.fontSize ) {\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t( nextProps?.style?.fontSize !== this.props?.style?.fontSize &&\n\t\t\t\t\tnextState.currentFontSize !==\n\t\t\t\t\t\tthis.state.currentFontSize ) ||\n\t\t\t\tnextState.currentFontSize !== this.state.currentFontSize ||\n\t\t\t\tnextProps?.style?.lineHeight !== this.props?.style?.lineHeight\n\t\t\t) {\n\t\t\t\tthis.needsSelectionUpdate = true;\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tcomponentDidMount() {\n\t\t// Request focus if wrapping block is selected and parent hasn't inhibited the focus request. This method of focusing\n\t\t//  is trying to implement the web-side counterpart of BlockList's `focusTabbable` where the BlockList is focusing an\n\t\t//  inputbox by searching the DOM. We don't have the DOM in RN so, using the combination of blockIsSelected and __unstableMobileNoFocusOnMount\n\t\t//  to determine if we should focus the RichText.\n\t\tif (\n\t\t\tthis.props.blockIsSelected &&\n\t\t\t! this.props.__unstableMobileNoFocusOnMount\n\t\t) {\n\t\t\tthis._editor.focus();\n\t\t\tthis.onSelectionChange(\n\t\t\t\tthis.props.selectionStart || 0,\n\t\t\t\tthis.props.selectionEnd || 0\n\t\t\t);\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tif ( this._editor.isFocused() ) {\n\t\t\tthis._editor.blur();\n\t\t}\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tconst { style, tagName } = this.props;\n\t\tconst { currentFontSize } = this.state;\n\n\t\tif ( this.props.value !== this.value ) {\n\t\t\tthis.value = this.props.value;\n\t\t}\n\t\tconst { __unstableIsSelected: isSelected } = this.props;\n\n\t\tconst { __unstableIsSelected: prevIsSelected } = prevProps;\n\n\t\tif ( isSelected && ! prevIsSelected ) {\n\t\t\tthis._editor.focus();\n\t\t\t// Update selection props explicitly when component is selected as Aztec won't call onSelectionChange\n\t\t\t// if its internal value hasn't change. When created, default value is 0, 0.\n\t\t\tthis.onSelectionChange(\n\t\t\t\tthis.props.selectionStart || 0,\n\t\t\t\tthis.props.selectionEnd || 0\n\t\t\t);\n\t\t} else if ( ! isSelected && prevIsSelected ) {\n\t\t\tthis._editor.blur();\n\t\t}\n\n\t\t// For font size values changes from the font size picker\n\t\t// we compare previous values to refresh the selected font size,\n\t\t// this is also used when the tag name changes\n\t\t// e.g Heading block and a level change like h1->h2.\n\t\tconst currentFontSizeStyle = this.getParsedFontSize( style?.fontSize );\n\t\tconst prevFontSizeStyle = this.getParsedFontSize(\n\t\t\tprevProps?.style?.fontSize\n\t\t);\n\t\tconst isDifferentTag = prevProps.tagName !== tagName;\n\t\tif (\n\t\t\t( currentFontSize &&\n\t\t\t\t( currentFontSizeStyle || prevFontSizeStyle ) &&\n\t\t\t\tcurrentFontSizeStyle !== currentFontSize ) ||\n\t\t\tisDifferentTag\n\t\t) {\n\t\t\tthis.setState( {\n\t\t\t\tcurrentFontSize: this.getFontSize( this.props ),\n\t\t\t} );\n\t\t}\n\t}\n\n\tgetHtmlToRender( record, tagName ) {\n\t\t// Save back to HTML from React tree.\n\t\tlet value = this.valueToFormat( record );\n\n\t\tif ( value === undefined ) {\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\n\t\t\tvalue = '';\n\t\t}\n\t\t// On android if content is empty we need to send no content or else the placeholder will not show.\n\t\tif (\n\t\t\t! this.isIOS &&\n\t\t\t( value === '' || value === EMPTY_PARAGRAPH_TAGS )\n\t\t) {\n\t\t\treturn '';\n\t\t}\n\n\t\tif ( tagName ) {\n\t\t\tlet extraAttributes = ``;\n\t\t\tif ( tagName === `ol` ) {\n\t\t\t\tif ( this.props.reversed ) {\n\t\t\t\t\textraAttributes += ` reversed`;\n\t\t\t\t}\n\t\t\t\tif ( this.props.start ) {\n\t\t\t\t\textraAttributes += ` start=${ this.props.start }`;\n\t\t\t\t}\n\t\t\t}\n\t\t\tvalue = `<${ tagName }${ extraAttributes }>${ value }</${ tagName }>`;\n\t\t}\n\t\treturn value;\n\t}\n\n\tgetEditableProps() {\n\t\treturn {\n\t\t\t// Overridable props.\n\t\t\tstyle: {},\n\t\t\tclassName: 'rich-text',\n\t\t\tonKeyDown: () => null,\n\t\t};\n\t}\n\n\tgetParsedFontSize( fontSize ) {\n\t\tconst { height, width } = Dimensions.get( 'window' );\n\t\tconst cssUnitOptions = { height, width, fontSize: DEFAULT_FONT_SIZE };\n\n\t\tif ( ! fontSize ) {\n\t\t\treturn fontSize;\n\t\t}\n\n\t\tconst selectedPxValue =\n\t\t\tgetPxFromCssUnit( fontSize, cssUnitOptions ) ?? DEFAULT_FONT_SIZE;\n\n\t\treturn parseFloat( selectedPxValue );\n\t}\n\n\tgetFontSize( props ) {\n\t\tconst { baseGlobalStyles, tagName, fontSize, style } = props;\n\t\tconst tagNameFontSize =\n\t\t\tbaseGlobalStyles?.elements?.[ tagName ]?.typography?.fontSize;\n\n\t\tlet newFontSize = DEFAULT_FONT_SIZE;\n\n\t\t// Disables line-height rendering for pre elements until we fix some issues with AztecAndroid.\n\t\tif ( tagName === 'pre' && ! this.isIOS ) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// For block-based themes, get the default editor font size.\n\t\tif ( baseGlobalStyles?.typography?.fontSize && tagName === 'p' ) {\n\t\t\tnewFontSize = baseGlobalStyles?.typography?.fontSize;\n\t\t}\n\n\t\t// For block-based themes, get the default element font size\n\t\t// e.g h1, h2.\n\t\tif ( tagNameFontSize ) {\n\t\t\tnewFontSize = tagNameFontSize;\n\t\t}\n\n\t\t// For font size values provided from the styles,\n\t\t// usually from values set from the font size picker.\n\t\tif ( style?.fontSize ) {\n\t\t\tnewFontSize = style.fontSize;\n\t\t}\n\n\t\t// Fall-back to a font size provided from its props (if there's any)\n\t\t// and there are no other default values to use.\n\t\tif ( fontSize && ! tagNameFontSize && ! style?.fontSize ) {\n\t\t\tnewFontSize = fontSize;\n\t\t}\n\n\t\t// We need to always convert to px units because the selected value\n\t\t// could be coming from the web where it could be stored as a different unit.\n\t\tconst selectedPxValue = this.getParsedFontSize( newFontSize );\n\n\t\treturn selectedPxValue;\n\t}\n\n\tgetLineHeight() {\n\t\tconst { baseGlobalStyles, tagName, lineHeight, style } = this.props;\n\t\tconst tagNameLineHeight =\n\t\t\tbaseGlobalStyles?.elements?.[ tagName ]?.typography?.lineHeight;\n\t\tlet newLineHeight;\n\n\t\t// Disables line-height rendering for pre elements until we fix some issues with AztecAndroid.\n\t\tif ( tagName === 'pre' && ! this.isIOS ) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif ( ! this.getIsBlockBasedTheme() ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// For block-based themes, get the default editor line height.\n\t\tif ( baseGlobalStyles?.typography?.lineHeight && tagName === 'p' ) {\n\t\t\tnewLineHeight = parseFloat(\n\t\t\t\tbaseGlobalStyles?.typography?.lineHeight\n\t\t\t);\n\t\t}\n\n\t\t// For block-based themes, get the default element line height\n\t\t// e.g h1, h2.\n\t\tif ( tagNameLineHeight ) {\n\t\t\tnewLineHeight = parseFloat( tagNameLineHeight );\n\t\t}\n\n\t\t// For line height values provided from the styles,\n\t\t// usually from values set from the line height picker.\n\t\tif ( style?.lineHeight ) {\n\t\t\tnewLineHeight = parseFloat( style.lineHeight );\n\t\t}\n\n\t\t// Fall-back to a line height provided from its props (if there's any)\n\t\t// and there are no other default values to use.\n\t\tif ( lineHeight && ! tagNameLineHeight && ! style?.lineHeight ) {\n\t\t\tnewLineHeight = lineHeight;\n\t\t}\n\n\t\t// Check the final value is not over the minimum supported value.\n\t\tif ( newLineHeight && newLineHeight < MIN_LINE_HEIGHT ) {\n\t\t\tnewLineHeight = MIN_LINE_HEIGHT;\n\t\t}\n\n\t\t// Until we parse CSS values correctly, avoid passing NaN values to Aztec\n\t\tif ( isNaN( newLineHeight ) ) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn newLineHeight;\n\t}\n\n\tgetIsBlockBasedTheme() {\n\t\tconst { baseGlobalStyles } = this.props;\n\n\t\treturn (\n\t\t\tbaseGlobalStyles && Object.entries( baseGlobalStyles ).length !== 0\n\t\t);\n\t}\n\n\tgetBlockUseDefaultFont() {\n\t\t// For block-based themes it enables using the defaultFont\n\t\t// in Aztec for iOS so it allows customizing the font size\n\t\t// for the Preformatted/Code and Heading blocks.\n\t\tif ( ! this.isIOS ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { tagName } = this.props;\n\t\tconst isBlockBasedTheme = this.getIsBlockBasedTheme();\n\t\tconst tagsToMatch = /pre|h([1-6])$/gm;\n\n\t\treturn isBlockBasedTheme && tagsToMatch.test( tagName );\n\t}\n\n\tgetLinkTextColor( defaultColor ) {\n\t\tconst { style } = this.props;\n\t\tconst customColor = style?.linkColor && colord( style.linkColor );\n\n\t\treturn customColor && customColor.isValid()\n\t\t\t? customColor.toHex()\n\t\t\t: defaultColor;\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\ttagName,\n\t\t\tstyle,\n\t\t\t__unstableIsSelected: isSelected,\n\t\t\tchildren,\n\t\t\tgetStylesFromColorScheme,\n\t\t\tminWidth,\n\t\t\tmaxWidth,\n\t\t\tformatTypes,\n\t\t\tparentBlockStyles,\n\t\t\taccessibilityLabel,\n\t\t\tdisableEditingMenu = false,\n\t\t\tbaseGlobalStyles,\n\t\t\tselectionStart,\n\t\t\tselectionEnd,\n\t\t\tdisableSuggestions,\n\t\t\tcontainerWidth,\n\t\t} = this.props;\n\t\tconst { currentFontSize } = this.state;\n\n\t\tconst record = this.getRecord();\n\t\tconst html = this.getHtmlToRender( record, tagName );\n\t\tconst editableProps = this.getEditableProps();\n\t\tconst blockUseDefaultFont = this.getBlockUseDefaultFont();\n\n\t\tconst placeholderStyle = getStylesFromColorScheme(\n\t\t\tstyles.richTextPlaceholder,\n\t\t\tstyles.richTextPlaceholderDark\n\t\t);\n\n\t\tconst { color: defaultPlaceholderTextColor } = placeholderStyle;\n\t\tconst fontSize = currentFontSize;\n\t\tconst lineHeight = this.getLineHeight();\n\n\t\tconst {\n\t\t\tcolor: defaultColor,\n\t\t\ttextDecorationColor: defaultTextDecorationColor,\n\t\t\tfontFamily: defaultFontFamily,\n\t\t} = getStylesFromColorScheme( styles.richText, styles.richTextDark );\n\t\tconst linkTextColor = this.getLinkTextColor(\n\t\t\tdefaultTextDecorationColor\n\t\t);\n\n\t\tconst currentSelectionStart = selectionStart ?? 0;\n\t\tconst currentSelectionEnd = selectionEnd ?? 0;\n\t\tlet selection = null;\n\t\tif ( this.needsSelectionUpdate ) {\n\t\t\tthis.needsSelectionUpdate = false;\n\t\t\tselection = {\n\t\t\t\tstart: currentSelectionStart,\n\t\t\t\tend: currentSelectionEnd,\n\t\t\t};\n\n\t\t\t// On AztecAndroid, setting the caret to an out-of-bounds position will crash the editor so, let's check for some cases.\n\t\t\tif ( ! this.isIOS ) {\n\t\t\t\t// The following regular expression is used in Aztec here:\n\t\t\t\t// https://github.com/wordpress-mobile/AztecEditor-Android/blob/b1fad439d56fa6d4aa0b78526fef355c59d00dd3/aztec/src/main/kotlin/org/wordpress/aztec/AztecParser.kt#L656\n\t\t\t\tconst brBeforeParaMatches = html.match( /(<br>)+<\\/p>$/g );\n\t\t\t\tif ( brBeforeParaMatches ) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t'Oops, BR tag(s) at the end of content. Aztec will remove them, adapting the selection...'\n\t\t\t\t\t);\n\t\t\t\t\tconst count = (\n\t\t\t\t\t\tbrBeforeParaMatches[ 0 ].match( /br/g ) || []\n\t\t\t\t\t).length;\n\t\t\t\t\tif ( count > 0 ) {\n\t\t\t\t\t\tlet newSelectionStart = currentSelectionStart - count;\n\t\t\t\t\t\tif ( newSelectionStart < 0 ) {\n\t\t\t\t\t\t\tnewSelectionStart = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet newSelectionEnd = currentSelectionEnd - count;\n\t\t\t\t\t\tif ( newSelectionEnd < 0 ) {\n\t\t\t\t\t\t\tnewSelectionEnd = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tselection = {\n\t\t\t\t\t\t\tstart: newSelectionStart,\n\t\t\t\t\t\t\tend: newSelectionEnd,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ( this.comesFromAztec ) {\n\t\t\tthis.comesFromAztec = false;\n\t\t\tthis.firedAfterTextChanged = false;\n\t\t}\n\n\t\t// Logic below assures that `RichText` width will always have equal value when container is almost fully filled.\n\t\tconst width =\n\t\t\tmaxWidth && this.state.width && maxWidth - this.state.width < 10\n\t\t\t\t? maxWidth\n\t\t\t\t: this.state.width;\n\t\tconst containerStyles = [\n\t\t\tstyle?.padding &&\n\t\t\t\tstyle?.backgroundColor && {\n\t\t\t\t\tpadding: style.padding,\n\t\t\t\t\tbackgroundColor: style.backgroundColor,\n\t\t\t\t},\n\t\t\tcontainerWidth && {\n\t\t\t\twidth: containerWidth,\n\t\t\t},\n\t\t];\n\n\t\tconst EditableView = ( props ) => {\n\t\t\tthis.customEditableOnKeyDown = props?.onKeyDown;\n\n\t\t\treturn <></>;\n\t\t};\n\n\t\treturn (\n\t\t\t<View style={ containerStyles }>\n\t\t\t\t{ children &&\n\t\t\t\t\tchildren( {\n\t\t\t\t\t\tisSelected,\n\t\t\t\t\t\tvalue: record,\n\t\t\t\t\t\tonChange: this.onFormatChange,\n\t\t\t\t\t\tonFocus: () => {},\n\t\t\t\t\t\teditableProps,\n\t\t\t\t\t\teditableTagName: EditableView,\n\t\t\t\t\t} ) }\n\t\t\t\t<RCTAztecView\n\t\t\t\t\taccessibilityLabel={ accessibilityLabel }\n\t\t\t\t\tref={ ( ref ) => {\n\t\t\t\t\t\tthis._editor = ref;\n\n\t\t\t\t\t\tif ( this.props.setRef ) {\n\t\t\t\t\t\t\tthis.props.setRef( ref );\n\t\t\t\t\t\t}\n\t\t\t\t\t} }\n\t\t\t\t\tstyle={ {\n\t\t\t\t\t\tbackgroundColor: styles.richText.backgroundColor,\n\t\t\t\t\t\t...style,\n\t\t\t\t\t\t...( this.isIOS && minWidth && maxWidth\n\t\t\t\t\t\t\t? { width }\n\t\t\t\t\t\t\t: { maxWidth } ),\n\t\t\t\t\t\tminHeight: this.state.height,\n\t\t\t\t\t} }\n\t\t\t\t\tblockUseDefaultFont={ blockUseDefaultFont }\n\t\t\t\t\ttext={ {\n\t\t\t\t\t\ttext: html,\n\t\t\t\t\t\teventCount: this.lastEventCount,\n\t\t\t\t\t\tselection,\n\t\t\t\t\t\tlinkTextColor,\n\t\t\t\t\t\ttag: tagName,\n\t\t\t\t\t} }\n\t\t\t\t\tplaceholder={ this.props.placeholder }\n\t\t\t\t\tplaceholderTextColor={\n\t\t\t\t\t\tstyle?.placeholderColor ||\n\t\t\t\t\t\tthis.props.placeholderTextColor ||\n\t\t\t\t\t\t( baseGlobalStyles && baseGlobalStyles?.color?.text ) ||\n\t\t\t\t\t\tdefaultPlaceholderTextColor\n\t\t\t\t\t}\n\t\t\t\t\tdeleteEnter={ this.props.deleteEnter }\n\t\t\t\t\tonChange={ this.onChangeFromAztec }\n\t\t\t\t\tonFocus={ this.onFocus }\n\t\t\t\t\tonBlur={ this.onBlur }\n\t\t\t\t\tonKeyDown={ this.onKeyDown }\n\t\t\t\t\ttriggerKeyCodes={\n\t\t\t\t\t\tdisableEditingMenu\n\t\t\t\t\t\t\t? []\n\t\t\t\t\t\t\t: this.suggestionOptions().map(\n\t\t\t\t\t\t\t\t\t( op ) => op.triggerChar\n\t\t\t\t\t\t\t  )\n\t\t\t\t\t}\n\t\t\t\t\tonPaste={ this.onPaste }\n\t\t\t\t\tactiveFormats={ this.getActiveFormatNames( record ) }\n\t\t\t\t\tonContentSizeChange={ this.onContentSizeChange }\n\t\t\t\t\tonCaretVerticalPositionChange={\n\t\t\t\t\t\tthis.props.onCaretVerticalPositionChange\n\t\t\t\t\t}\n\t\t\t\t\tonSelectionChange={ this.onSelectionChangeFromAztec }\n\t\t\t\t\tblockType={ { tag: tagName } }\n\t\t\t\t\tcolor={\n\t\t\t\t\t\t( style && style.color ) ||\n\t\t\t\t\t\t( parentBlockStyles && parentBlockStyles.color ) ||\n\t\t\t\t\t\t( baseGlobalStyles && baseGlobalStyles?.color?.text ) ||\n\t\t\t\t\t\tdefaultColor\n\t\t\t\t\t}\n\t\t\t\t\tmaxImagesWidth={ 200 }\n\t\t\t\t\tfontFamily={ this.props.fontFamily || defaultFontFamily }\n\t\t\t\t\tfontSize={ fontSize }\n\t\t\t\t\tlineHeight={ lineHeight }\n\t\t\t\t\tfontWeight={ this.props.fontWeight }\n\t\t\t\t\tfontStyle={ this.props.fontStyle }\n\t\t\t\t\tdisableEditingMenu={ disableEditingMenu }\n\t\t\t\t\tisMultiline={ this.isMultiline }\n\t\t\t\t\ttextAlign={ this.props.textAlign }\n\t\t\t\t\t{ ...( this.isIOS ? { maxWidth } : {} ) }\n\t\t\t\t\tminWidth={ minWidth }\n\t\t\t\t\tid={ this.props.id }\n\t\t\t\t\tselectionColor={ this.props.selectionColor }\n\t\t\t\t\tdisableAutocorrection={ this.props.disableAutocorrection }\n\t\t\t\t/>\n\t\t\t\t{ isSelected && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<FormatEdit\n\t\t\t\t\t\t\tforwardedRef={ this._editor }\n\t\t\t\t\t\t\tformatTypes={ formatTypes }\n\t\t\t\t\t\t\tvalue={ record }\n\t\t\t\t\t\t\tonChange={ this.onFormatChange }\n\t\t\t\t\t\t\tonFocus={ () => {} }\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{ ! disableSuggestions && (\n\t\t\t\t\t\t\t<BlockFormatControls>\n\t\t\t\t\t\t\t\t<ToolbarButtonWithOptions\n\t\t\t\t\t\t\t\t\toptions={ this.suggestionOptions() }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</BlockFormatControls>\n\t\t\t\t\t\t) }\n\t\t\t\t\t</>\n\t\t\t\t) }\n\t\t\t</View>\n\t\t);\n\t}\n}\n\nRichText.defaultProps = {\n\tformat: 'string',\n\tvalue: '',\n\ttagName: 'div',\n};\n\nconst withFormatTypes = ( WrappedComponent ) => ( props ) => {\n\tconst {\n\t\tclientId,\n\t\tidentifier,\n\t\twithoutInteractiveFormatting,\n\t\tallowedFormats,\n\t} = props;\n\tconst { formatTypes } = useFormatTypes( {\n\t\tclientId,\n\t\tidentifier,\n\t\twithoutInteractiveFormatting,\n\t\tallowedFormats,\n\t} );\n\n\treturn <WrappedComponent { ...props } formatTypes={ formatTypes } />;\n};\n\nexport default compose( [\n\twithSelect( ( select, { clientId } ) => {\n\t\tconst { getBlockParents, getBlock, getSettings } =\n\t\t\tselect( 'core/block-editor' );\n\t\tconst parents = getBlockParents( clientId, true );\n\t\tconst parentBlock = parents ? getBlock( parents[ 0 ] ) : undefined;\n\t\tconst parentBlockStyles = parentBlock?.attributes?.childrenStyles;\n\n\t\tconst settings = getSettings();\n\t\tconst baseGlobalStyles = settings?.__experimentalGlobalStylesBaseStyles;\n\n\t\tconst colorPalettes = settings?.__experimentalFeatures?.color?.palette;\n\t\tconst colorPalette = colorPalettes\n\t\t\t? flatColorPalettes( colorPalettes )\n\t\t\t: settings?.colors;\n\n\t\treturn {\n\t\t\tareMentionsSupported: settings?.capabilities?.mentions === true,\n\t\t\tareXPostsSupported: settings?.capabilities?.xposts === true,\n\t\t\tparentBlockStyles,\n\t\t\tbaseGlobalStyles,\n\t\t\tcolorPalette,\n\t\t};\n\t} ),\n\twithPreferredColorScheme,\n\twithFormatTypes,\n] )( RichText );\n"]}